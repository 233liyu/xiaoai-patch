

# 进入uboot

这个还是比较简单的，就是连上tty, 然后`screen /dev/tty.usbmodemXXX 115200` 就可以, 上电之后，快速一波Ctrl + C，就会进入uboot。

# 参考资料

[如何进入uboot, 修改img](https://javabin.cn/2021/xiaoai_fm.html)

* 如何解开img, 修改文件，重新打包
* 如何通过ymodem烧录rootfs
* 如何通过uboot命令行烧录，使用nand写镜像


[如何下载img](../research/updates.md)


## 刷镜像指令

0x000000800000-0x000001000000 : "tpl"
0x000001000000-0x000001600000 : "boot0"
0x000001600000-0x000001c00000 : "boot1"
0x000001c00000-0x000004400000 : "system0"
0x000004400000-0x000006c00000 : "system1"
0x000006c00000-0x000008000000 : "data"
ESMT SLC 128MiB 3.3V 8-bit F59L1G81Mxxx


{"app_id":"527512289645953024","user_id":"6239948137","device_id":"27446/A0QH366
77","bind_id":"49e0bb9e-c582-4da3-93b5-f21d2232afc6","xiaoai_token":"Authorizati
on: MIOT-TOKEN-V1 app_id:527512289645953024,token:x2sfoqb0lv,session_id:2287_352
703972_1736430769353084537","token_type":2,"token":"xiNZq349GIz3d2liZzBr1shbyn3T
4+yYO3hrz2Z9lgzP6TqrIcgHcR6t3JCnEhPs5+MVIoZ5+H+yNWGAjGOcB5Yfq5ykJpYybFAUl5QFSMRl
tJU3YxYg1hSSrQ6gU2xuUbjCaXnQWEh/og1tc0mknZoZ4BdR5VkfwhK8TDXXx79chpaIjXyfD3TP0tER
T23f","uuid":67257139816038400,"service_key":"FjG3pkDRGaK54Ij26T9+xw==","expire_
at":1737035585433}

scp /data/dropbear/rsa.key 

nand erase.part system0

nand write 0x01080000 system0 2800000


run bootcmd



<!--  -->

cd /tmp && wget http://192.168.0.101:8000/xiao.img
mtd write /tmp/xiao.img system0


# patch 讲解

[设置ssh](../patches/10_ssh.patch)

[串口自动登录](../patches/11_autologin_serial.patch)

[修改密码](https://github.com/jialeicui/open-lx01?tab=readme-ov-file#%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81-%E5%A6%82%E6%9E%9C%E6%83%B3-ssh-%E6%AD%A3%E5%B8%B8%E7%99%BB%E5%BD%95-%E6%AD%A4%E6%AD%A5%E5%BF%85%E9%A1%BB)

[关闭 dsa 校验](../patches/30_libmico-pam.patch)

[保留设置过的密码](../patches/l09a/31_persistent_shadow.patch)

# 看过的内容

[xiaoai-patches中如何实现自定义的语音助手](../packages/porcupine/config/launcher)
这个里面包含了如何从http服务中获得配置，然后用这个配置和ha交互 stt -> conversation -> tts 

# 待办事项
1. 关闭常驻服务
2. arecord 录音测试
3. 实现一个websocket的client支持vad, 并将sst发送到服务端, 拿到以后开始解析


`/usr/share/mipns/vpm` 这个包下看起来是有一个xiaomi自己的vad model. dnn 看看能不能拿来用

ubus call mibrain text_to_speech "{\"text\":\"开始上传日志\",\"save\":0}"

miplayer 可以直接播放音乐

需要移除 pns mipns_xiaomi pns_ubus_helper


通过nc发送到mac
arecord -N -Dmico_record -f S16_LE -c 1 -r 16000 | nc 192.168.0.184 8088

mac 接受, 并通过sox放大音量
nc -l 8088 | sox -t raw -r 16000 -e signed -b 16 -c 1   - -t wav ./record.wav vol 20.0 compand 0.3,1 6:-70,-60,-20 -5 -90 0.2 

mac 上通过nc 接收到一个服务中


# 时间同步
需要设置一个crontab定时任务
ntpd -d -nq -p 0.pool.ntp.org -p 1.pool.ntp.org -p 2.pool.ntp.org


[增加 mico 麦克风](../patches/24_alsa_change_default.patch)

# 还没想明白的问题

* [ ] 如何获取麦克风的设备
* [ ] sst 和 对话交互是直接开始, 还是分开进行, 返回到客户端
* [ ] 用golang实现一个websocket的client, 库的支持怎么样? 后台服务部署在哪里
* [X] 关键词唤醒，是不是有硬件解决了这个问题？ 不需要通过cpu计算; 看起来没有 需要自己实现


# 打包操作

构建镜像
docker build -t xiaoai-patch packages


# diff 生成patch
diff -up origin_file new_file > patch_file

diff -up mypatches/wireless squashfs-root/etc/init.d/wireless > mypatches/wifi.patch